<?php
/**
 * This file is part of Kabooodle.
 * Copyright (c) 2017. Kabooodle,LLC <help@kabooodle.com>
 */

namespace Kabooodle\Services\Mail;

use Illuminate\Mail\Mailer as Laravel_Mailer;

/**
 * Class Mailer
 * @package Kabooodle\Services\Mail
 */
class Mailer extends Laravel_Mailer
{
    /**
     * Send a new message using a view.
     *
     * @param  string|array  $view
     * @param  array  $data
     * @param  \Closure|string  $callback
     * @return void
     */
    public function send($view, array $data = [], $callback = null)
    {
        $this->forceReconnection();

        // First we need to parse the view, which could either be a string or an array
        // containing both an HTML and plain text versions of the view which should
        // be used when sending an e-mail. We will extract both of them out here.
        list($view, $plain, $raw) = $this->parseView($view);

        $data['message'] = $message = $this->createMessage();

        // Once we have retrieved the view content for the e-mail we will set the body
        // of this message using the HTML type, which will provide a simple wrapper
        // to creating view based emails that are able to receive arrays of data.
        $this->addContent($message, $view, $plain, $raw, $data);

        $this->callMessageBuilder($callback, $message);

        if (isset($this->to['address'])) {
            $message->to($this->to['address'], $this->to['name'], true);
        }

        $message = $message->getSwiftMessage();

        // Added to allow/force headers relative to PostmarkApp
        $message->getHeaders()->addTextHeader('TrackOpens', true);
        $message->getHeaders()->addTextHeader('X-PM-TrackOpens', true);

        return $this->sendSwiftMessage($message);
    }
}
